# Практическое руководство по сбору (scraping) и загрузке (ETL)

Ниже — конкретные рекомендации по парсингу страниц sudrf и порталов, экстракции полей и сопоставлению со схемами/таблицами.

## Универсальные советы

1. **User-Agent + politeness:** указывайте явный идентифицируемый UA, соблюдайте паузы между запросами.
2. **Кодировки:** страницы `*.sudrf.ru` иногда отдают cp1251/KOI8-R — определяйте через `chardet`/`requests.apparent_encoding`.
3. **Robots и 262‑ФЗ:** не все категории и персональные данные публикуются; возможны «дырки» в хронологии.
4. **Устойчивость:** храните `source_url` и `raw_sha256` (хэш сырого HTML/PDF) в `ingestion_runs`.

## Парсинг семейств страниц

### A) Шаблон `*.sudrf.ru/modules.php?name=sud_delo`

- **Списки на дату**: таблица с колонками «Номер дела», «Стороны», «Дата и время заседания», «Стадия», «Судья», «Зал».
  - Из строк извлекаем «ссылку на номер дела» → карточка дела (`name_op=case`).
  - Для «Документы» — переходы `name_op=doc` (параметры `number`, `text_number`, `delo_id`, `srv_num` и т.д.).
- **Карточка дела (`name_op=case`)**: блоки «Категория дела», «Текущее состояние», «История состояний», «Судебные заседания», «Документы».
- **Документ (`name_op=doc`)**: заголовок «РЕШЕНИЕ/ОПРЕДЕЛЕНИЕ/…», дата, состав суда, **основной текст** (иногда в `<pre>`/`<div>`). Возможны вложенные ссылки на скачивание RTF/PDF.

### B) Портал MOS-GORSUD (`mos-gorsud.ru`)

- **Списки**: эндпоинты `/services/cases/first-*`, `/board-*`, `/rs/<суд>/services/cases/...` — таблицы с пагинацией/фильтрами.
- **Карточка дела**: `/services/cases/<тип>/details/{uuid}` — блоки «Текущее состояние», «История состояний», «Документы», «Судебные заседания».
- **Документы**: `/cases/docs/content/{uuid}` — HTML-контент акта (иногда разбит на параграфы).

## Сопоставление с БД

- **Courts**: заведите суд при первом обнаружении, связывайте все сущности через `court_uid`.
- **Cases**: `UNIQUE (court_uid, case_number)`, обновляйте `status`, `category`, `judges` по мере появления.
- **Hearings**: upsert по `(case_uid, scheduled_start, judge)` с доп. проверками текста ячеек.
- **Documents**: `UNIQUE (text_sha256)` + `UNIQUE (url)`; при совпадении `text_sha256` — обновляйте только метадату.
- **Extracted fields**: `INSERT` новой версии (не затирать), храните `confidence` и `evidence_spans`.

## Пайплайн (ETL пример)

1. **Скачать HTML карточки дела** → извлечь `cases` + `hearings` ссылки.
2. **Скачать документы** → нормализовать текст → вставить в `documents` (+ `document_applied_articles`).
3. **Прогнать LLM-экстракцию** → `extracted_decision_fields`.
4. **Сформировать чанки + эмбеддинги** → `vector_document_chunks` и `vector_extracted_facts` (pgvector).
   Дополнительно: `etl/vector_sync.py` — апсерты в Pinecone/Weaviate/Qdrant.

## Контроль качества

- **Дедупликация:** сравнивайте `text_sha256`, `case_number`, `decision_date`.
- **Дата/время:** нормализуйте в `Europe/Moscow` или по `timezone` суда, храните в `TIMESTAMPTZ`.
- **Анонимизация:** уважайте маскировку персональных данных на источнике; **не пытайтесь деанонимизировать**.
